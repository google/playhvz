
<dom-module id="leaderboard-summary">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
     Polymer({
      is: 'leaderboard-summary',

      properties: {
        serverBridge: Object,
        gameId: String,
        players: {
          type: Array,
          value: function() { return []; },
        },
        numToShow: {
          type: Number,
          value: 3,
        },
        pollInterval: { //in seconds
          type: Number,
          value: 10,
        },

        leaderboardDelegate: {
          type: Object,
          value: function() {
            return {
              getSchema: (() => ["name", "points"]),
              getHeader: ((key) => ({name: 'Name', points: 'Points'}[key])),
              getActions: (() => ["view", "grr"]),
              getActionName: ((action) => ({view: "View", grr: "Grr"}[action])),
              create: this.createLeaderboardContents_.bind(this),
              update: this.updateLeaderboardContents_.bind(this),
              doAction: this.doTableAction_.bind(this),
            };
          },
        },
      },

      attached: function() {
        this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
      },

      observers: [
      "ready_(serverBridge, gameId)",
      ],

      ready_: function(serverBridge, gameId) {
        serverBridge.findAllPlayersForGameId(gameId)
        .then((players) => {
          players.sort(Utils.byPoints);
          this.players = players.slice(0, this.numToShow);
        });

        setInterval(this.pollPlayers_.bind(this), this.pollInterval * 1000);
      },

      pollPlayers_: function() {
        this.serverBridge.findAllPlayersForGameId(this.gameId)
        .then((players) => {
          players.sort(Utils.byPoints);
          this.players = players.slice(0, this.numToShow);
        });
      },

      doTableAction_: function(player, action) {
        console.log('do action', action, ' on player', player);
        if (action == "view") {
          console.log("view");
        }
      },

      createLeaderboardContents_: function(player, key) {
        // if we dont return anything, auto-table will just by default create the text node
      },

      updateLeaderboardContents_: function(element, player, propertyName, propertyPath, value) {
          //return document.createTextNode(player[key]);
        },

        refresh_: function() {
          this.serverBridge.findAllPlayersForGameId(this.gameId)
          .then((players) => {
            if (players) {
              this.players = [];
              players.sort(Utils.byPoints);
              this.players = players.slice(0, this.numToShow);
            }
          });
        },
      });
   });
 </script>
 <template>
  <style>
    auto-table {
      display: block;
    }
  </style>
  <paper-icon-button
  id="refresh"
  icon="icons:refresh"
  on-tap="refresh_">
</paper-icon-button>
<auto-table
id="leaderboardTable"
delegate="[[leaderboardDelegate]]"
items="[[players]]">
</auto-table>
</template>
</dom-module>
