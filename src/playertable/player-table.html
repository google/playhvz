
<dom-module id="player-table">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'player-table',

        properties: {
          serverBridge: Object,

          gameId: String,

          game: Object,

          players: {
            type: Array,
            value: function() { return []; },
          },

          pollInterval: {
            type: Number,
            value: 30,  // in seconds
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        makeTableBlueprint_: function() {
          return {
            columns: [
              {
                property: "number",
                name: "Number",
                sortable: true,
                filterable: true
              },
              {
                name: "Name",
                sortable: true,
                filterable: true,
                getModel: player => player.name,
                getView: (player) => {
                  var div = document.createElement('div');
                  div.appendChild(document.createTextNode(player.name));
                  var iconButton = document.createElement('paper-icon-button');
                  iconButton.classList.add("player-icon");
                  iconButton.icon = "icons:open-in-new";
                  iconButton.dataset.playerId = player.id;
                  div.appendChild(iconButton);
                  this.scopeSubtree(div); // So we can style it from our <style>
                  return div;
                }
              },
              {
                name: "Allegiance",
                sortable: true,
                filterable: true,
                getModel: (player) => {
                  if (player.species == 'human') {
                    return 'Resistance';
                  } else if (player.species == 'zombie') {
                    return 'Horde';
                  } else {
                    return player.species;
                  }
                },
              },
              {
                name: "Life Code",
                sortable: true,
                filterable: true,
                getModel: (player) => {
                  if (player.species == 'human') {
                    if (player.lives.length) {
                      return player.lives[player.lives.length - 1].lifeCode;
                    }
                  }
                  return "";
                },
              },
              {
                name: "Rewards",
                sortable: true,
                filterable: true,
                getModel: (player) => {
                  let rewardNames = [];
                  var rewardNamesByCategoryId = new Map();
                  for (const rewardCategory of this.game.rewardCategories)
                    rewardNamesByCategoryId.set(rewardCategory.id, rewardCategory.name);
                  for (const rewardCategoryId of player.rewardCategoryIds)
                    rewardNames.push(rewardNamesByCategoryId.get(rewardCategoryId));
                  return rewardNames.join(", ");
                }
              },
            ],
            actions: [
              {
                action: "delete",
                name: "Delete",
                handler: (player) => {
                  var index = this.players.indexOf(player);
                  this.splice('players', index, 1);
                }
              },
              {
                action: "infect",
                name: "Infect"
              },
              {
                action: "revive",
                name: "Revive"
              },
              {
                action: "ban",
                name: "Ban"
              },
            ],
          };
        },

        ready_: function(serverBridge, gameId) {
          this.refresh_();

          setInterval(this.refresh_.bind(this), this.pollInterval * 1000);
        },

        onDeletePlayer_: function(player) {
          var index = this.players.indexOf(player);
          if (index < 0) {
            console.error('Cant delete player, player not in list:', player);
            return;
          }
          this.splice('players', 1);
        },

        refresh_: function() {
          this.serverBridge.getGameById(this.gameId)
              .then((game) => {
                this.game = game;
                return this.serverBridge.findAllPlayersForGameId(this.gameId);
              })
              .then((players) => {
                this.players = players;
              });
        },
      });
    });
  </script>
  <template>
    <style>
      auto-table {
        display: block;
      }
      .player-icon {
        opacity: .5;
      }
    </style>
    <paper-icon-button
        id="refresh"
        icon="icons:refresh"
        on-tap="refresh_">
    </paper-icon-button>
    <auto-table
        id="playersTable"
        selectable
        blueprint="[[makeTableBlueprint_()]]"
        items="[[players]]">
    </auto-table>
  </template>
</dom-module>
