<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-dialog/paper-dialog.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-input/paper-input.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-button/paper-button.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-fab/paper-fab.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/paper-input/paper-textarea.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-a11y-keys/iron-a11y-keys.html">
<link rel="import" href="https://cdn.rawgit.com/download/polymer-cdn/1.7.0.2/lib/iron-flex-layout/iron-flex-layout-classes.html">

<!--
TODO(SquirrelThief):
- add "clear" button for dev to erase all chat messages
- wrap message display so messages don't go off screen
- autoscroll to bottom of chat
- display user profile pic
- split into two modules, one for chat-room and one for chat-page
- add list of chat participants
- add list of available chat rooms
- create a new chat room
- display time of message
-->


<dom-module id="chat-app">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
    	Polymer({
    		is: 'chat-app',

    		properties: {
          serverBridge: Object,

          gameId: String,

          currentPlayerId: String,

          chatRoomId: String,

          player: {
            type: Object,
            value: function() { return {}; },
          },

          chatRoom: {
            type: Object,
            value: function() { return {}; },
          },

          playerIds: {
            type: Array,
            value: function() { return []; },
          },

          playersInChat: {
            type: Array,
            value: function() { return[]; },
          },

          pollInterval: {
            type: Number,
            value: 1,  // in seconds
          },
        },

        observers: [
        "chatRoomReady_(serverBridge, chatRoomId)",
        "currentPlayerIdReady_(serverBridge, currentPlayerId)",
        ],

        chatRoomReady_: function(serverBridge, chatRoomId) {
          serverBridge.getChatRoomById(chatRoomId)
          .then((chatRoom) => {
            // Get player names for all the playerIds in the chatRoom
            this.serverBridge.getMultiplePlayersById(chatRoom.playerIds)
            .then((playersInChat) => {
              this.playersInChat = playersInChat;
              // Only update chat messages once we finished getting player
              // names, otherwise the elements redraw and we don't have names
              this.chatRoom = chatRoom;
            });
          });

          setInterval(this.pollPlayers_.bind(this), this.pollInterval * 1000);
          setInterval(this.pollMessages_.bind(this), this.pollInterval * 1000);
        },

        pollMessages_: function() {
          var afterId = this.chatRoom.messages.slice(-1)[0].id;
          this.serverBridge.findMessagesForChatRoom(this.chatRoom.id, afterId)
          .then((messages) => {
            for (var index in messages) {
              this.push('chatRoom.messages', messages[index]);
            }
          });
        },

        pollPlayers_: function() {
          this.serverBridge.findAllPlayerIdsForChatRoomId(this.chatRoomId)
          .then((playerIds) => {
            this.chatRoom.playerIds = playerIds;
            // Get player names for all the playerIds in the chatRoom
            this.serverBridge.getMultiplePlayersById(playerIds)
            .then((playersInChat) => {
              this.playersInChat = playersInChat;
            });
          });
        },

        currentPlayerIdReady_: function(serverBridge, currentPlayerId) {
          serverBridge.getPlayerById(currentPlayerId)
          .then((player) => {
            this.player = player;
          });
        },

        computeMessageDisplayClass_(senderId, myId) {
          return senderId === myId ? 'message-from-me' : 'message-from-other';
        },

        /**
        * Sends messages to the server and retrieves any messages since last 
        * check. 
        */
        onSendClicked_: function() {
          if (!this.$.messageInput.value) {
            return;
          }

          this.serverBridge.addMessageToChatRoom(this.chatRoom.id, 
            this.player.id, this.$.messageInput.value);
          this.$.messageInput.value = "";  

          var afterId = this.chatRoom.messages.slice(-1)[0].id;

          this.serverBridge.findMessagesForChatRoom(this.chatRoom.id, afterId)
          .then((messages) => {
            for (var index in messages) {
              this.push('chatRoom.messages', messages[index]);
            }
          });
        },

        /**
        * Submit text on 'enter', allow shift+enter to insert a new line in
        * the text field.
        */
        checkForEnter_: function(e) {
         if (e.keyCode === 13 && !e.shiftKey) {
          e.preventDefault();
          this.$.messageSend.click();
        }
      },

      getName_(playerId) {
        var name = this.playersInChat[playerId].name;
        if (!this.playersInChat[playerId]) {
          this.serverBridge.getPlayerById(playerId)
          .then((player) => {
            this.playersInChat[playerId] = player;
            return this.playersInChat[playerId].name;
          });
        } else {
          return this.playersInChat[playerId].name;
        }
      },
    });
});
</script>

<template>
 <style include="iron-flex iron-flex-alignment">
  .player-name {
    font-size: 10px;
  }

  .message-from-other {
    display: flex;
    justify-content: flex-start;
  }

  .message-from-me {
    display: flex;
    justify-content: flex-end;
  }

  .message-from-me > .player-name {
    padding-left: 8px;
    order: 3;
  }

  .message-from-other > .player-name {
    padding-right: 8px;
    order: 1;
  }

  .display-message {
    white-space: pre;
    order: 2;
  }

  .textbox {
    padding-top: 8px;
  }

  .textbox-input-field {
    @apply(--layout-flex);
  }
</style>
<!-- Display messages -->
<template is="dom-repeat" items="[[chatRoom.messages]]">
  <div class$="layout horizontal [[computeMessageDisplayClass_(item.playerId, player.id)]]">
    <div class="display-message">[[item.message]]</div>
    <div class="player-name">[[getName_(item.playerId)]]</div>
  </div> 
</template>

<!-- Text Input -->
<div class="layout horizontal textbox">
  <paper-textarea 
  class="textbox-input-field"
  id="messageInput"
  autocorrect
  multiline
  max-rows=3
  label="message"
  no-label-float
  on-keydown="checkForEnter_">
</paper-textarea>
<paper-button
class="flex-0"
id="messageSend" 
raised 
style="background-color: #7e57c2; color: white" 
on-click="onSendClicked_">
->
</paper-button>
</div>

</template>
</dom-module>