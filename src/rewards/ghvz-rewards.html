
<dom-module id="ghvz-rewards">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-rewards',

        properties: {
          serverBridge: Object,

          gameId: String,

          game: Object,

          rewardCategoryId: {
            type: String,
            value: null,
            observer: 'refreshRewardsTable_',
          },

          rewards: {
            type: Array,
            value: () => [],
          },

          playersById: {
            type: Object,
            value: () => new Map(),
          },

          newRewardCode: {
            type: String,
            value: "",
          },

          newCategoryName: {
            type: String,
            value: "",
          },

          newCategoryPoints: {
            type: String,
            value: "",
          },

          newCategorySeed: {
            type: String,
            value: "",
          },

          categoryNewName: String,

          categoriesTableDelegate: {
            type: Object,
            value: function() {
              return {
                getSchema: (() => {
                  return [
                    {property: "name", name: "Name"},
                    {property: "points", name: "Points"},
                    {property: "claimed", name: "Claimed"},
                    {property: "seed", name: "Seed"},
                  ];
                }),
                getActions: (() => {
                  return [
                    {action: "show", name: "Show Rewards"},
                    {action: "setpoints", name: "Set Points"},
                    {action: "setname", name: "Set Name"},
                  ];
                }),
                create: this.getCategoriesTableContents_.bind(this),
                doAction: this.doCategoriesTableAction_.bind(this),
              };
            },
          },

          rewardsTableDelegate: {
            type: Object,
            value: function() {
              return {
                getSchema: (() => {
                  return [
                    {property: "rewardCode", name: "Code"},
                    {property: "claimer", name: "Claimer"},
                  ];
                }),
                getActions: (() => {
                  return [
                    {action: "delete", name: "Delete"},
                  ];
                }),
                create: this.getRewardsTableContents_.bind(this),
                doAction: this.doRewardsTableAction_.bind(this),
              };
            },
          },
        },

        attached: function() {
          this.fire('ghvz-dashlet-add-toolbar-button', { button: this.$.refresh });
        },

        observers: [
          "ready_(serverBridge, gameId)",
        ],

        ready_: function(serverBridge, gameId) {
          this.refresh_();
        },

        doCategoriesTableAction_: function(category, action) {
          if (action == 'show') {
            this.rewardCategoryId = category.id;
          } else if (action == 'setname') {
            Utils.showDialog("Enter the new name of the category:", "name", category.name, null)
                .then(
                    (newName) => {
                      if (newName) {
                        this.serverBridge.setRewardCategoryName(category.id, newName);
                        this.refresh_();
                      }
                    });
          }
        },

        doRewardsTableAction_: function(player, action) {
        },

        getCategoriesTableContents_: function(category, propertyName) {
          if (propertyName == 'claimed') {
            return category.claimed + '/' + category.total;
          }
        },

        getRewardsTableContents_: function(reward, propertyName) {
          if (propertyName == 'claimer') {
            if (reward.playerIdOrNull == null) {
              return "(unclaimed)";
            } else {
              var player = this.playersById.get(reward.playerIdOrNull);
              return player ? player.name : "(unknown!)";
            }
          }
        },

        refresh_: function() {
          this.serverBridge.getGameById(this.gameId)
              .then((game) => {
                this.game = game;
              })
          this.serverBridge.findAllPlayersForGameId(this.gameId)
              .then((players) => {
                this.playersById = new Map();
                for (let player of players)
                  this.playersById.set(player.id, player);
              });
          this.refreshRewardsTable_();
        },

        refreshRewardsTable_: function() {
          if (this.rewardCategoryId) {
            this.serverBridge.findRewardsForRewardCategoryId(this.rewardCategoryId)
                .then((rewards) => {
                  this.rewards = rewards;
                });
          }
        },

        addCategory_: function() {
          this.serverBridge.addRewardCategory(
              Utils.generateId("rewardCategory"), this.gameId, this.newCategoryName, this.newCategoryPoints, this.newCategorySeed);
          this.newCategoryName = "";
          this.newCategoryPoints = "";
          this.newCategorySeed = "";
          this.refresh_();
        },

        addRewards_: function() {
          this.serverBridge.addRewards(this.rewardCategoryId, this.numNewRewards);
          this.numNewRewards = "";
          this.refreshRewardsTable_();
        },

        enableAddCategory_(newCategoryName, newCategoryPoints, newCategorySeed) {
          return newCategoryName && newCategoryPoints && newCategorySeed;
        },
      });
    });
  </script>
  <template>
    <style>
      paper-input {
        --paper-input-container: {
          padding: 0;
        }
      }
      #rewards {
        margin-top: 16px;
      }
      #rewardsTable {
      }
      #rewardCodeInput {
        flex: 1;
        margin: 0 8px;
      }
      .wide-input-row {
        margin: 0 8px;
      }
      .input-row {
        display: flex;
      }
      .input-row paper-input {
        min-width: 100px;
      }
      .input-description {
        display: flex;
        align-items: flex-end;
      }
      #addReward,
      #addCategory {
        margin: 8px;
        white-space: nowrap;
      }
      .input-row paper-input {
        margin: 0 8px;
      }

      #newReward {
        display: flex;
      }
      #addCategoryContainer {
        display: flex;
        justify-content: flex-end;
      }
      #addRewardContainer {
        display: flex;
        align-items: flex-end;
      }
      #newCategoryNameInput {
        margin-bottom: 8px;
      }
    </style>
    <paper-icon-button
        id="refresh"
        icon="icons:refresh"
        on-tap="refresh_">
    </paper-icon-button>

    <div id="categories">
      <auto-table
          id="categoriesTable"
          delegate="[[categoriesTableDelegate]]"
          items="[[game.rewardCategories]]">
      </auto-table>
      <div id="newCategory">
        <div class="wide-input-row">
          <paper-input
              id="newCategoryNameInput"
              label="Name"
              value="{{newCategoryName}}">
          </paper-input>
          Title of the category. Users will see this next to the icon in their
          profile and when they hover over the icon.
        </div>
        <div class="input-row">
          <paper-input
              id="newCategoryPointsInput"
              type="number"
              label="Points"
              value="{{newCategoryPoints}}">
          </paper-input>
          <div class="input-description">
            Num points gained by claiming one of this category's rewards.
            0 is a valid value (for example for vaccines).
          </div>
        </div>
        <div class="input-row">
          <paper-input
              id="newCategorySeedInput"
              label="Seed"
              value="{{newCategorySeed}}">
          </paper-input>
          <div class="input-description">
            A word to prefix codes with. Must be unique. Also
            used as a random seed for generating the codes. Example: derp.
          </div>
        </div>
        <div id="addCategoryContainer">
          <paper-button
              id="addCategory"
              raised
              disabled="[[!enableAddCategory_(newCategoryName, newCategoryPoints, newCategorySeed)]]"
              on-tap="addCategory_">
            Add Category
          </paper-button>
        </div>
      </div>
    </div>

    <div id="rewards" hidden="[[!rewardCategoryId]]">
      <div id="newReward">
        <paper-input
            id="rewardCodeInput"
            label="Num rewards to generate"
            value="{{numNewRewards}}">
        </paper-input>
        <div id="addRewardContainer">
          <paper-button
              id="addReward"
              raised
              disabled="[[!numNewRewards]]"
              on-tap="addRewards_">
            Add Rewards
          </paper-button>
        </div>
      </div>

      <auto-table
          id="rewardsTable"
          delegate="[[rewardsTableDelegate]]"
          items="[[rewards]]">
      </auto-table>
    </div>
  </template>
</dom-module>
