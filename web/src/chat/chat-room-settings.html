<dom-module id="ghvz-chat-room-settings">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-chat-room-settings',

        properties: {
          bridge: Object,
          gameId: String,
          player: Object,

          doneEnabled: {
            type: Boolean,
            value: false,
          },

          newName: {
            type: String,
            value: "",
          },
        },

        observers: [
          'updateDoneEnabled_(newName)',
        ],

        computeChatPage_: function(chatRoomId) {
          return "chat/" + chatRoomId;
        },

        openForCreate: function() {
          this.$.settingsForm.open();
        },

        updateDoneEnabled_: function(newName) {
          if (this.newName == "") {
            this.doneEnabled = false;
            return;
          }
          this.doneEnabled = true;
        },

        createChatRoom_: function(bridge, player) {
          this.doneEnabled = false;
          let name = this.$.chatName.value;

          let groupId = Bridge.GroupId.generate();
          this.bridge.createGroup({
            groupId: groupId,
            gameId: this.gameId,
            ownerPlayerId: this.player.id,
            allegianceFilter: '',
            autoAdd: false,
            autoRemove: false,
            membersCanAdd: true,
            membersCanRemove: false,
          });
          var chatRoomId = Bridge.ChatRoomId.generate();
          this.bridge.createChatRoom({
            chatRoomId: chatRoomId,
            groupId: groupId,
            name: name
          });
          this.bridge.addPlayerToGroup({
            groupId: groupId,
            playerId: this.player.id,
            playerToAddId: this.player.id
          });
          this.fire('ghvz-open-page', {
            page: this.computeChatPage_(chatRoomId),
          });
        },
      });
    });
  </script>
  <style include="iron-flex iron-flex-alignment">
    :host {
      display: block;
    }
    .contents {
      padding: 8px;
    }
  </style>
  <template>
    <ghvz-form
      id="settingsForm"
      title="Chat Settings"
      close-label="Cancel"
      done-label="Create"
      done-enabled="[[doneEnabled]]"
      on-ghvz-form-done="createChatRoom_">
      <div class="contents">
        <paper-input 
          id="chatName"
          auto-validate
          error-message="Name required!"
          label="Name"
          no-label-float
          maxlength="40"
          value="{{newName}}">
        </paper-input>
      </div>
    </ghvz-form>
  </template>
</dom-module>