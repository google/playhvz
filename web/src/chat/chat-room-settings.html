<dom-module id="ghvz-chat-room-settings">
  <script>
    // Not sure why this HTMLImports.whenReady is really needed.
    // Something about polymer initialization order.
    // I think we're not supposed to need this.
    HTMLImports.whenReady(() => {
      Polymer({
        is: 'ghvz-chat-room-settings',

        properties: {
          bridge: Object,
          gameId: String,
          player: Object,
          isAdmin: Boolean,

          doneEnabled: {
            type: Boolean,
            value: false,
          },

          newName: {
            type: String,
            value: "",
          },
        },

        observers: [
          'updateDoneEnabled_(newName)',
        ],

        computeChatPage_: function(chatRoomId) {
          return "chat/" + chatRoomId;
        },

        openForCreate: function() {
          this.$.settingsForm.open();
        },

        updateDoneEnabled_: function() {
          if (this.newName == "") {
            this.doneEnabled = false;
            return;
          }
          this.doneEnabled = true;
        },

        createChatRoom_: function(bridge, player) {
          this.doneEnabled = false;
          let name = this.$.chatName.value;

          let groupId = Bridge.GroupId.generate();
          this.bridge.createGroup({
            groupId: groupId,
            gameId: this.gameId,
            ownerPlayerId: this.player.id,
            allegianceFilter: '',
            autoAdd: false,
            autoRemove: false,
            membersCanAdd: true,
            membersCanRemove: false,
          });
          var chatRoomId = Bridge.ChatRoomId.generate();
          this.bridge.createChatRoom({
            chatRoomId: chatRoomId,
            groupId: groupId,
            name: name,
            withAdmin: false,
          });
          this.bridge.addPlayerToGroup({
            groupId: groupId,
            playerId: this.player.id,
            playerToAddId: this.player.id
          });
          this.fire('ghvz-open-page', {
            page: this.computeChatPage_(chatRoomId),
          });
        },

        getPlayerAllegiance_() {
          return PlayerUtils.computeAllegiance(this.player);
        },
      });
    });
  </script>
  <style include="iron-flex iron-flex-alignment">
    :host {
      display: block;
    }
    paper-checkbox {
      --paper-checkbox-vertical-align: top;
      --paper-checkbox-margin: 2px 0 0 0;
    }
    .contents {
      @apply(--layout-vertical)
      padding: 8px;
    }
    .input {
      padding-top: 16px;
    }
    .option {
      font-size: 16px;
      padding-top: 16px;
    }
    .subtext {
      color: darkgrey;
      font-size: 12px;
    }
  </style>
  <template>
    <ghvz-form
      id="settingsForm"
      title="Chat Settings"
      close-label="Cancel"
      done-label="Create"
      done-enabled="[[doneEnabled]]"
      on-ghvz-form-done="createChatRoom_">
      <div class="contents">
        <paper-input 
          id="chatName"
          class="input"
          auto-validate
          error-message="Name required!"
          label="Name"
          no-label-float
          maxlength="40"
          value="{{newName}}">
        </paper-input>
        <template is="dom-if" if="[[!isAdmin]]">
          <paper-checkbox class="option">
            [[getPlayerAllegiance_(player)]] only
            <div class="subtext">
            Have the server prune players from chat if they are no longer [[getPlayerAllegiance_(player)]]
            </div>
          </paper-checkbox>
        </template>
        <template is="dom-if" if="[[isAdmin]]">
          <paper-checkbox class="option">
            Set alliegance filter
            <div class="subtext">
            Have the server prune players from chat if they are no longer the specified alliegance
            </div>
          </paper-checkbox>
          <!-- <radio-group>
            <paper-radio-button> Resistance </paper-radio-button>
            <paper-radio-button> Horde </paper-radio-button>
          </radio-group> -->
        </template>
        <paper-checkbox class="option">
          Disable add players
          <div class="subtext">
            Only you control who can be in this chat
          </div>
        </paper-checkbox>
        <template is="dom-if" if="[[isAdmin]]">
          <paper-checkbox class="option">
            Disable leaving
            <div class="subtext">
              Use with care! Players can't leave this chat unless you kick them out
            </div>
          </paper-checkbox>
          <paper-checkbox class="option">
            Automatically add members
            <div class="subtext">
              Auto add new players based on the Alliegance filter, if no alliegance filter is set auto add all players in the game to this chat
            </div>
          </paper-checkbox>  
        </template>
      </div>
    </ghvz-form>
  </template>
</dom-module>